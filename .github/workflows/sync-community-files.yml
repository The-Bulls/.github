name: Sync Community Files to New Repos

on:
  repository_dispatch:
    types: [new_repo_created]  # Triggered by the detect-new-repos workflow

jobs:
  sync_files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout .github repository
        uses: actions/checkout@v4

      - name: Get repository name
        run: echo "NEW_REPO=${{ github.event.client_payload.repo_full_name }}" >> $GITHUB_ENV

      - name: Prepare community files
        run: |
          # Remove existing directories to avoid conflicts
          rm -rf community-files .github/workflows
          mkdir -p community-files .github/workflows  # Ensure directories exist

          # Copy community files only if they exist
          for file in CONTRIBUTING.md CODE_OF_CONDUCT.md SECURITY.md LICENSE; do
            [[ -f $file ]] && cp $file community-files/
          done

          # Copy workflow files safely if they exist
          for wf in .github/workflows/auto_merge.yml .github/workflows/sync-community-files.yml; do
            [[ -f $wf ]] && cp $wf community-files/ || echo "Warning: $wf not found, skipping..."
          done

      - name: Clone the new repository
        run: |
          git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/${NEW_REPO}.git new-repo
          cd new-repo

          # Ensure we only copy files that actually exist
          if [ -d ../community-files ]; then
            cp -r ../community-files/* .
          fi
          
          # Ensure .github/workflows exists and copy workflow files if they exist
          mkdir -p .github/workflows
          if [ -f ../community-files/auto_merge.yml ]; then
            cp ../community-files/auto_merge.yml .github/workflows/
          else
            echo "Warning: auto_merge.yml not found in community-files, skipping copy..."
          fi

          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

          git add .
          git commit -m "Add community standard files" || echo "No changes to commit"
          git push origin main || echo "No changes to push"
